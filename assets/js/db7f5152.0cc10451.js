"use strict";(self.webpackChunksonr_docs=self.webpackChunksonr_docs||[]).push([[8293],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return f}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var d=a.createContext({}),s=function(e){var t=a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=s(e.components);return a.createElement(d.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,d=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=s(n),f=i,m=p["".concat(d,".").concat(f)]||p[f]||c[f]||r;return n?a.createElement(m,o(o({ref:t},u),{},{components:n})):a.createElement(m,o({ref:t},u))}));function f(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=p;var l={};for(var d in t)hasOwnProperty.call(t,d)&&(l[d]=t[d]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var s=2;s<r;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7105:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return d},default:function(){return f},frontMatter:function(){return l},metadata:function(){return s},toc:function(){return c}});var a=n(7462),i=n(3366),r=(n(7294),n(3905)),o=["components"],l={title:"ADR-006",id:"adr-006",displayed_sidebar:"resourcesSidebar"},d="ADR-006: Deployable Functions",s={unversionedId:"reference/adr-006",id:"reference/adr-006",title:"ADR-006",description:"Introduction",source:"@site/articles/reference/ADR-006.md",sourceDirName:"reference",slug:"/reference/adr-006",permalink:"/articles/reference/adr-006",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/articles/reference/ADR-006.md",tags:[],version:"current",frontMatter:{title:"ADR-006",id:"adr-006",displayed_sidebar:"resourcesSidebar"},sidebar:"resourcesSidebar",previous:{title:"ADR-005",permalink:"/articles/reference/adr-005"}},u={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Abstract",id:"abstract",level:2},{value:"User functions",id:"user-functions",level:2},{value:"Function definition format",id:"function-definition-format",level:3},{value:"URL Schema",id:"url-schema",level:2},{value:"params to a user defined function over URL",id:"params-to-a-user-defined-function-over-url",level:3},{value:"Function Parameters",id:"function-parameters",level:2},{value:"Returning data from a user defined function",id:"returning-data-from-a-user-defined-function",level:2},{value:"Invoking a User Defined Function",id:"invoking-a-user-defined-function",level:2},{value:"Models and Methods (Highway)",id:"models-and-methods-highway",level:2},{value:"Methods",id:"methods",level:3},{value:"CreateFunction()",id:"createfunction",level:4},{value:"UpdateFunction()",id:"updatefunction",level:4},{value:"CLI Commands",id:"cli-commands",level:2},{value:"Diagrams",id:"diagrams",level:2}],p={toc:c};function f(e){var t=e.components,l=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},p,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"adr-006-deployable-functions"},"ADR-006: Deployable Functions"),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"Implement user defined functions invokable over HTTP within Highway."),(0,r.kt)("h2",{id:"abstract"},"Abstract"),(0,r.kt)("p",null,"The goal of user-defined functions is to allow for custom-defined behavior, defined by users which are accessible via ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP"),".\nThese functions will all be accessible over a single endpoint, predefined within the highway."),(0,r.kt)("p",null,"When a request is sent to a static endpoint, containing the desired name of the invokable function, the function will be then invoked, with a single parameter queried from ",(0,r.kt)("inlineCode",{parentName:"p"},"ipfs")," by the given ",(0,r.kt)("inlineCode",{parentName:"p"},"CID")," in the declaration of the url."),(0,r.kt)("h2",{id:"user-functions"},"User functions"),(0,r.kt)("p",null,"A User ",(0,r.kt)("inlineCode",{parentName:"p"},"Defined Function")," is repersented by a single ",(0,r.kt)("inlineCode",{parentName:"p"},"binary")," file which is assumed to be executable, and corresponding ",(0,r.kt)("inlineCode",{parentName:"p"},"callback Urls")," associated with said executable file. said functions are not permitted to return data to the caller directly, but rather the outer managment of the defined function will provide data to the given ",(0,r.kt)("inlineCode",{parentName:"p"},"urls")," as ",(0,r.kt)("inlineCode",{parentName:"p"},"base64 encoded")," repersentations as to not permit users to modify the system state of any ",(0,r.kt)("inlineCode",{parentName:"p"},"highway")," node directly."),(0,r.kt)("h3",{id:"function-definition-format"},"Function definition format"),(0,r.kt)("p",null,"The user's defined function is assumed to be precompiled into binary format. Said Binary is ",(0,r.kt)("inlineCode",{parentName:"p"},"jailed")," as to resrtrict privlages on the execution enviorment to the host."),(0,r.kt)("p",null,"Currently, the executable options are more appealing as it is easier to sandbox a plain binary into a \u2018jail\u2019 rather than implementing sandboxing around a reflection execution implementation.\nBelow is a primitive definition for a user-defined function.\nSaid binary is stored within the highway node's ",(0,r.kt)("inlineCode",{parentName:"p"},"ipfs")," storage with the following file contents as a blob of ",(0,r.kt)("inlineCode",{parentName:"p"},"JSON")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},'UserFunction {\n    did string // did from defintion\n    file []bytes // file as a byte encoding\n    parameters: map[string]string // not the value string is the "type"\n}\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"In the above definition, the total size of the file stored for a user function would be the total bytes of the array and the did string of the owner.\nThis data would be stored on IPFS incurring the cost of file storage and passing that on to the uploader of the function.")),(0,r.kt)("p",null,"Once a function is associated with a name and provided to the highway, a function will then have the association of label \u2192 function.\nEach function will be a single relation to the user-given function.\nMeaning a function can be resolved via its name ",(0,r.kt)("inlineCode",{parentName:"p"},"name")," but a function cannot resolve its name, as the function is not explicitly required to have an associative name that matches its function name."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"{\n    did: string\n    ref: cid\n    isActive: boolean\n}\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"The above model will be stored within the chain upon ",(0,r.kt)("inlineCode",{parentName:"p"},"creation")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"update"),". This chain store will incur a cost on the uploader. Later changing the function to inactive will also incur a cost on chain.")),(0,r.kt)("p",null,"The above model is then stored as a file in ",(0,r.kt)("inlineCode",{parentName:"p"},"IPFS")," queriable by the returned ",(0,r.kt)("inlineCode",{parentName:"p"},"CID"),"."),(0,r.kt)("h2",{id:"url-schema"},"URL Schema"),(0,r.kt)("p",null,"User Defined functions within the Highway will have a single entry point. "),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"/sonr/functions/invoke/{version}/{label}")),(0,r.kt)("p",null,"Where ",(0,r.kt)("inlineCode",{parentName:"p"},"label")," is defined when the definition of the function is created."),(0,r.kt)("h3",{id:"params-to-a-user-defined-function-over-url"},"params to a user defined function over URL"),(0,r.kt)("p",null,"callback? (base64 encoding).\ncid? (id of the content from a highway node you wish to provide to a function)\nthe above URL has two params "),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"queryCid"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Content ID to be retrieved from file storage (object, blob)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"returnData"),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"A ",(0,r.kt)("inlineCode",{parentName:"td"},"URL")," that will be called and given the returned data from a function")))),(0,r.kt)("h2",{id:"function-parameters"},"Function Parameters"),(0,r.kt)("p",null,"Parameters to functions will be nameless and of type ",(0,r.kt)("inlineCode",{parentName:"p"},"string"),". the provided data will be deserailized to the described types and given to functions as what they are specified to be in the delceration upon creation. Parameters to functions will be applied in the order as they are provided, content queried by the ",(0,r.kt)("inlineCode",{parentName:"p"},"CID")," provided URL when the function is invoked will be the last parameter to the function. The function implementor is responsible for the mapping of the parameters based on the index when implementing."),(0,r.kt)("h2",{id:"returning-data-from-a-user-defined-function"},"Returning data from a user defined function"),(0,r.kt)("p",null,"User defined functions cannot modify the state of ",(0,r.kt)("inlineCode",{parentName:"p"},"highways"),", meaning data stored within the network. Instead one or many ",(0,r.kt)("inlineCode",{parentName:"p"},"callback URLs")," are specifiable, allowing for data to be sent to said urls through ",(0,r.kt)("inlineCode",{parentName:"p"},"url encoding")," data return by any function must be ",(0,r.kt)("inlineCode",{parentName:"p"},"encodable")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"Base64")," standard or data will not be sent."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"callback URLs")," can be either an external resource outside of the network of highways, or can be another function defined on the highway."),(0,r.kt)("h2",{id:"invoking-a-user-defined-function"},"Invoking a User Defined Function"),(0,r.kt)("p",null,"A function that's invoked should have the following defined within the ",(0,r.kt)("inlineCode",{parentName:"p"},"body")," of the ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP")," request"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-="},"{\n    did string // owner did\n    label: string // file as a byte encoding\n    cid: string // identifier of the function stored within ipfs.\n    parameters: map[string]string\n    callbackURLS: string[]\n}\n")),(0,r.kt)("p",null,"The return value will simply be an empty response body with an ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP")," status."),(0,r.kt)("p",null,'When a function is "invoked" we will use one of the following strategies for calulating cost for a given function\'s invokation.'),(0,r.kt)("table",null,(0,r.kt)("tr",null,(0,r.kt)("th",null),(0,r.kt)("th",null,"Description"),(0,r.kt)("th",null,"Formula"),(0,r.kt)("th",null,"User Pays"),(0,r.kt)("th",null,"Highway Runner Gets"),(0,r.kt)("th",null,"Function Writer Gets")),(0,r.kt)("tr",null,(0,r.kt)("td",null,"Static Cost Functions"),(0,r.kt)("td",null,"Cost is staticly defined at function creation time. The run time cost is added in addition to the cost paid by the caller"),(0,r.kt)("td",null,"total_cost = static_cost + runtime_fees"),(0,r.kt)("td",null,"total_cost"),(0,r.kt)("td",null,"runtime_fees"),(0,r.kt)("td",null,"static_cost")),(0,r.kt)("tr",null,(0,r.kt)("td",null,"Variable Cost Functions"),(0,r.kt)("td",null,"Cost is defined when the function is running. There is a max and min cost that can be paid from the caller's wallet predefined in the function definition. The caller will also need to fund a transaction to refund the remainder of the gas fees to caller."),(0,r.kt)("td",null,"total_cost = variable_cost + runtime_fees + gas_fees"),(0,r.kt)("td",null,"total_cost"),(0,r.kt)("td",null,"runtime_fees"),(0,r.kt)("td",null,"variable_cost")),(0,r.kt)("tr",null,(0,r.kt)("td",null,'"Free" Functions'),(0,r.kt)("td",null,"The function only costs as much as the runtime_fees"),(0,r.kt)("td",null,"total_cost = runtime_fees"),(0,r.kt)("td",null,"total_cost"),(0,r.kt)("td",null,"runtime_fees"),(0,r.kt)("td",null,"N/A"))),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Static and Varible functions are useful when the function needs to make its own interaction with the chain or fund calls within. ")),(0,r.kt)("h2",{id:"models-and-methods-highway"},"Models and Methods (Highway)"),(0,r.kt)("p",null,"The following methods will be added to ",(0,r.kt)("inlineCode",{parentName:"p"},"Highway")," as a module within ",(0,r.kt)("inlineCode",{parentName:"p"},"x")),(0,r.kt)("h3",{id:"methods"},"Methods"),(0,r.kt)("h4",{id:"createfunction"},"CreateFunction()"),(0,r.kt)("p",null,"Creates a new function with the provided ",(0,r.kt)("inlineCode",{parentName:"p"},"label")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"definition")," (function converted to ",(0,r.kt)("inlineCode",{parentName:"p"},"bytes"),")"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"type FunctionDefiniton struct {\n    label string\n    did string\n    definition []byte\n        parameters: map[string]type\n}\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Returns")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json="},'{\n    "code": int,\n    "did": "string"\n    "cid": "string"\n}\n')),(0,r.kt)("h4",{id:"updatefunction"},"UpdateFunction()"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go="},"type FunctionDefiniton struct {\n    label string\n    did string\n    definition []byte \n}\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Updating a function does not remove the previous function defintion, as there could be reliance on said function. Updating a function creates a new instance of an already defined function by requiring a new  version specified in the URL.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Returns")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "code": int,\n    "did": "string"\n    "cid": "string"\n}\n')),(0,r.kt)("h2",{id:"cli-commands"},"CLI Commands"),(0,r.kt)("p",null,"The CLI will need a single root level command called ",(0,r.kt)("inlineCode",{parentName:"p"},"function"),". function will have the following two sub commands"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"params"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"add"),(0,r.kt)("td",{parentName:"tr",align:null},'"name" "path-to-binary"'),(0,r.kt)("td",{parentName:"tr",align:null},"Adds a single function to a defined name")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"remove"),(0,r.kt)("td",{parentName:"tr",align:null},'"name"'),(0,r.kt)("td",{parentName:"tr",align:null},"Removes user defined function from the function table")))),(0,r.kt)("h2",{id:"diagrams"},"Diagrams"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://www.figma.com/embed?embed_host=share&url=https%3A%2F%2Fwww.figma.com%2Ffile%2Fv9E6Om23rm80JROFHVnr31%2FHighway-sdk-user-defined-functions-(non-faas)%3Fnode-id%3D0%253A1"},(0,r.kt)("img",{alt:"Writing encrypted data",src:n(4548).Z,width:"2268",height:"1476"}))))}f.isMDXComponent=!0},4548:function(e,t,n){t.Z=n.p+"assets/images/user-functions-adr-6-560d79af0f23f4cbc003936825402222.png"}}]);